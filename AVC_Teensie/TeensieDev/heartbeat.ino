///////////////////////////////////////////////////////////////////////////////
// heartbeat - Functions associated with the heartbeat protocol.  If we dont' 
// receive a heartbeat at least every 1/2 second we signal an estop.
///////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////
// Local header files
///////////////////////////////////////////////////////////////////////////////
#include "telemetry.h"
#include "vehicle.h"

///////////////////////////////////////////////////////////////////////////////
// extern global variables - defined in the main file
///////////////////////////////////////////////////////////////////////////////
extern Telemetry telem;                // The telemetry class

///////////////////////////////////////////////////////////////////////////////
// local global variables
///////////////////////////////////////////////////////////////////////////////

uint32_t lastHeartbeatCount = 0;
uint32_t lastHeartbeatTime  = 0;

///////////////////////////////////////////////////////////////////////////////
// hb_init - initialize the heartbeat system
///////////////////////////////////////////////////////////////////////////////
void hb_init ()
{
    // Empty
}

///////////////////////////////////////////////////////////////////////////////
// hb_command - called when we get the heartbeat command
///////////////////////////////////////////////////////////////////////////////
uint32_t hb_command (uint16_t count)
{
    // Check if the counts correspond within 1/2 second - todo
    lastHeartbeatCount = count;
    lastHeartbeatTime  = millis();
    return (true);
}

///////////////////////////////////////////////////////////////////////////////
// hb_check - perform the continuing checking if we received the heartbeat.
// Called by the main loop routine
///////////////////////////////////////////////////////////////////////////////
void hb_check (uint32_t currTime)
{
    // Have we not received a heartbeat in 500 milliseconds?
    if (currTime > (lastHeartbeatTime + 500))
    {
        veh_estop();
        telem.currMode = ESTOP;
        telem.bist = HEARTBEAT;
    }
}
